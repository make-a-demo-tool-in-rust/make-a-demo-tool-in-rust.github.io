<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>1.2 ops.rs - Operators</title>

    <!-- Styles and fonts -->
    <link href="/themes/epsilon/stylesheets/epsilon-8f0057ad.css" rel="stylesheet" />
    <link href="/themes/epsilon/stylesheets/syntax-e33ab3a1.css" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Lato:100,300,400,700|Noticia+Text:400,400italic,700,700italic&subset=latin,latin-ext,vietnamese' rel='stylesheet' type='text/css'>

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <script src="/themes/epsilon/javascripts/modernizr-16671e9f.js"></script>

    <link rel="alternate" type="application/rss+xml" title="RSS Feed - Updates" href="https://make-a-demo-tool-in-rust.github.io/feed.xml">
  </head>

  <body class="x1-2-ops-rs epsilon">
    <div class="page-wrapper">

      <a id="menu-toggle" class="menu-toggle" href="#sidr"><span class="bitcon-list"></span><span class="menu-toggle-text">Toggle Menu</span></a>
      <header class="page-header" role="banner">
<a href="/" class="invisilink">            <span class="book-title">Make a Demo Tool in Rust</span>
</a>        <span class="book-author">by etd</span>
      </header>

        <div class="content-wrapper clearfix">

          <!--[if lt IE 7]>
              <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
          <![endif]-->

          <section class="main-content" role="main">
            <div class="main-content-source">
              <h1 id="opsrs---operators">1.2 ops.rs - Operators</h1>

<p>In the <a href="https://github.com/make-a-demo-tool-in-rust/fish-in-a-jit/tree/master/src">source repo</a> you will see an <strong>ops_unix.rs</strong> and
<strong>ops_windows.rs</strong>. The only difference is that the <code>extern</code> functions use the
<code>sysv64</code> ABI on Linux and Mac, while they use the <code>C</code> ABI on Windows.</p>

<p>The JIT function makes calls to functions in our Rust code. The operations are
implemented by taking a pointer to <code>Context</code> as the first argument, and the
other arguments can come from destructuring the <code>enum</code>.</p>

<p>For example, when building the JIT, <code>Operator::Exit(30.0)</code> will be translated to
a function call:</p>

<pre class="highlight rust"><code><span class="nn">Ops</span><span class="p">::</span><span class="n">exit</span> <span class="k">as</span> <span class="k">extern</span> <span class="s">"sysv64"</span> <span class="k">fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">Context</span><span class="p">,</span> <span class="nb">f32</span><span class="p">)</span>
</code></pre>
<p>Which is implemented as:</p>

<pre class="highlight rust"><code><span class="c">// ops.rs</span>

<span class="k">impl</span> <span class="n">Ops</span> <span class="k">for</span> <span class="n">Context</span> <span class="p">{</span>

    <span class="c">/// We use `.is_running` as the break condition for the main drawing loop.</span>
    <span class="c">/// This sets `.is_running` to `false` if `.time` is over the `limit`.</span>
    <span class="k">extern</span> <span class="s">"sysv64"</span> <span class="k">fn</span> <span class="nf">exit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">f32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.time</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="p">{</span>
            <span class="k">self</span><span class="py">.is_running</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
<p>These are the calls which are arranged with <code>x86</code> instructions. Before the
actual function call, in the JIT we will have to arrange argument values on the
stack and in CPU registers according to the conventions of the CPU hardware and
how the OS uses that CPU.</p>

<p><code>x86_32</code> expects function arguments on the stack, so youâ€™d have to push values
onto the stack before making the call.</p>

<p><code>x86_64</code> expects function arguments in the registers in a certain order, but
this order is different on Windows and Linux.</p>

<p>Because, why should general-purpose operating systems agree on how to use the
same general-purpose processor? Let go and move on.</p>

<p>So we have to anticipate that convention when putting in the <code>x86</code> instructions,
and the Rust compiler also has to know what convention to use for the <code>extern</code>
function on the given OS and arch.</p>

<p>When writing the <code>extern</code> functions, we just have to tag it accordingly. We only
target <code>x86_64</code>. On Linux and Mac the ABI is <code>sysv64</code> for
the <a href="https://en.wikipedia.org/wiki/X86_calling_conventions#System_V_AMD64_ABI">System V AMD64 ABI</a>, and on Windows it is <code>C</code> which effecively
means the <a href="https://msdn.microsoft.com/en-us/library/7kcdt6fy.aspx">Windows x64 calling convention</a>.</p>

<p>When writing the JIT, there will be a wee bit more documentation-digging.</p>


            </div>
            <nav class="main-content-nav clearfix" role="navigation">
              <ul>
                <li><a href="/1-1-dmo-rs.html" class="previous">Previous</a></li>
                <li><a href="/1-3-jit-rs.html" class="next">Next</a></li>
              </ul>
            </nav>
          </section>

          <aside id="sidr" class="aside-content" role="complementary">
            <div class="aside-wrapper">

              <div class="block table-of-contents">
                <h3>Table of contents</h3>
                <nav role="navigation">
                  <ul>
                    <li class='child '><a href="/">Home</a></li><li class='child '><a href="/0-0-introduction.html">Introduction</a></li><li class='child '><a href="/1-0-fish-in-a-jit.html">1. Fish in a JIT</a></li><li class='child '><a href="/1-1-dmo-rs.html">1.1 dmo.rs - State and content</a></li><li class='child active'><a href="/1-2-ops-rs.html">1.2 ops.rs - Operators</a></li><li class='child '><a href="/1-3-jit-rs.html">1.3 jit.rs - A hand-made function</a></li><li class='child '><a href="/1-4-bytecode-rs.html">1.4 bytecode.rs - Blob</a></li><li class='child '><a href="/1-5-ascii-fish-example.html">1.5 ASCII fish example</a></li><li class='child '><a href="/assembly-tutorial.html">Assembly Tutorial</a></li><li class='child '><a href="/reference-docs.html">Reference Docs</a></li>
                  </ul>
                </nav>
              </div>

              <div class="block open-source">
                <h3>Sources</h3>
                <p>
                    Get the
                    <a href="https://github.com/make-a-demo-tool-in-rust/make-a-demo-tool-in-rust.github.io" target="_blank">source of this book</a>
                    and
                    <a href="https://github.com/make-a-demo-tool-in-rust/make-a-demo-tool-in-rust-code" target="_blank">all the code</a>
                    from Github.
                </p>
              </div>

              <!--
              <div class="block downloads">
                <h3>Downloads</h3>
                <p>Download this book in
                    <a href="#">PDF</a>, <a href="#">mobi</a>, and <a href="#">epub</a>
                  form for free.
                </p>
              </div>
              -->

              <!--
              <div class="block license">
                <h3>License</h3>
                <p>This book is licensed under the <a href="https://creativecommons.org/publicdomain/zero/1.0/">do-whatever-you-want</a> license.</p>
              </div>
              -->

            </div><!-- end aside-wrapper -->
          </aside>

        </div><!-- end content-wrapper -->

      <footer class="page-footer">
        <div class="footer-wrapper">
        </div><!-- end footer-wrapper -->
      </footer>

    </div><!-- end page-wrapper -->

    <!-- include scripts just before the close of the body tag -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="/themes/epsilon/javascripts/jquery.sidr.min-9c1c3fff.js"></script>
    <script src="/themes/epsilon/javascripts/anchor.min-9893b39a.js"></script>
    <script src="/themes/epsilon/javascripts/epsilon-5a4259e9.js"></script>

    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
         m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-3557338-11', 'auto');
     ga('send', 'pageview');
    </script>
  </body>
</html>
